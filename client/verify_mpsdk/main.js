const regeneratorRuntime=require("./utils/regenerator-runtime/runtime"),util=require("./utils/util"),defaultConfig=require("./config.js").defaultConfig,extend=require("./utils/extend.js").extend;var init=function(e){wx.onNetworkStatusChange(function(e){"none"!=e.networkType&&"2g"!=e.networkType||wx.showToast({title:"网络异常",icon:"none"})}),wx.onMemoryWarning(function(){wx.showToast({title:"内存告警，有闪退风险",icon:"none"})}),wx.verifyBaseUrl="dev"===e.env?"http://open.iauth.tencentcloudapi.com":"https://faceid.qq.com",wx.verifyLog=function(){for(let e=0;e<arguments.length;e++)console.log(arguments[e])},wx.startVerify=function(e){if(wx.verifyLog("startVerify start, send data",e.data),e.data&&e.fail&&e.success)wx.verifySuccessFunc=e.success,wx.verifyFailureFunc=e.fail,util.validate(e.data.token,"token")?(wx.verifyLog("data is ok",e.data),wx.showLoading({title:"加载中...",mask:!0}),getCmsConfig(e.data.token,function(i){if(wx.verifyLog(i),wx.hideLoading(),0===i.ErrorCode){extend(!0,defaultConfig,i.Data.config);var o=defaultConfig;console.log("final cmsConfig"),console.log(o),wx.verifySysInfo=wx.getSystemInfoSync(),wx.verifyLog(wx.verifySysInfo);var t="ios"===wx.verifySysInfo.platform?o.JustForMp.iOSVerLimit:o.JustForMp.androidVerLimit;if("devtools"!==wx.verifySysInfo.platform&&t&&util.compareVersion(t,wx.verifySysInfo.version)>0)return e.fail({ErrorCode:-105,ErrorMsg:`当前微信版本低于${t}，无法使用该功能，请升级到最新微信版本后重试。`}),void wx.hideLoading();o=reviseCmsConfig("",o),wx.verify_CMSConfig=o,wx.verify_TOKEN=e.data.token;console.log("进入验证页面"),wx.navigateTo({url:"/verify_mpsdk/index/index?isNotice="+!1})}else e.fail(i)})):e.fail({error_code:-102,error_msg:"调用失败，token格式错误！"});else{var i={error_code:-100,error_msg:"调用失败，传入参数错误！"};wx.showModal({title:"提示",content:i.error_code+" "+i.error_msg,showCancel:!1})}}},getCmsConfig=async function(e,i){try{var o={method:"POST",url:`${wx.verifyBaseUrl}/api/auth/getConfig?BizToken=${e}`},t=await util.requestPromise(o);200===t.statusCode&&t.data.Data&&0===t.data.ErrorCode?i({ErrorCode:0,Data:t.data.Data}):t.data.ErrorCode?i({ErrorCode:t.data.ErrorCode,ErrorMsg:t.data.ErrorMsg}):i({ErrorCode:-104,ErrorMsg:"调用失败，获取配置异常！"})}catch(e){wx.verifyLog("genConfig catch error",e),e.errMsg.indexOf("request:fail Unable to resolve host")>=0||e.errMsg.indexOf("request:fail 似乎已断开与互联网的连接")>=0?i({ErrorCode:101,ErrorMsg:"网络异常，请稍后重试"}):"request:fail url not in domain list"===e.errMsg?i({ErrorCode:-104,ErrorMsg:"接口还未添加到服务器域名，请点击右上角三个点，打开调试模式再试"}):i({ErrorCode:-104,ErrorMsg:"调用失败，获取配置接口异常！"})}},reviseCmsConfig=function(e,i){let o=i.Common.Flow,t=!1,r=!1,n=!1,s=!1,a=0,l=o.indexOf("LiveFour1V1")>=0||o.indexOf("LiveAction1V1")>=0||o.indexOf("LiveSilence1V1")>=0;-1===o.indexOf("Sms")&&(t=!0),-1===o.indexOf("Ocr")&&(r=!0),l&&(a=o.indexOf("LiveFour1V1")>=0?0:o.indexOf("LiveAction1V1")>=0?1:2),l||-1!==o.indexOf("Sms")||(n=!0),l||-1!==o.indexOf("Ocr")||(s=!0);let d={protocol:{title:i.Index.ProtocolTitle,content:i.Index.TencentProtocol,clientContent:i.Index.ClientProtocol},page:{index:{clientName:i.Index.ProjectName,businessName:i.Index.BusinessName,certificationCenter:i.Index.CooperationName,nextBtnName:i.Index.NextBtn,isHideTipsLogo:!i.Common.IsShowLogo,isHideTipsAbout:i.Common.IsHideAbout,protocolTitle:i.Index.ProtocolEntrance},ocr:{backend:i.Ocr.Backend,isAddress:i.Ocr.IsAddress,isManualInput:i.Ocr.IsManualInput,isHideTakePhoto:i.Ocr.IsHideManualInputTakePhotoBtn,isCheckIDInfo:i.Ocr.IsCheckIdInfo,allowModifyType:i.Ocr.AllowModifyType},livingbody:{silentRecordTime:i.LiveFour1V1.MaxDuration},success:{successTitle:i.Success.SubTipsName,successTips:i.Success.SuccessTips,isAutoSkip:i.Success.AutoSkip},sms:{},failpage:{isShowExitBtn:i.Fail.IsShowQuitBtn,exitBtnTtile:i.Fail.ExitBtnText}},runEnv:"release",navTitle:{smsTitle:i.Common.NavTitle.SmsTitle,ocrTitle:i.Common.NavTitle.OcrTitle,livingbodyTitle:i.Common.NavTitle.LivingbodyTitle,resultTitle:i.Common.NavTitle.ResultTitle},justForJumpVer:{title:i.Common.Title},about:{title:"关于云智慧眼",content:"云智慧眼由腾讯AI Lab、腾讯优图、腾讯数据平台部提供技术支持"},isGetUserLocation:i.Index.IsGetLocation,isHideSmsPage:t,isHideOcrPage:r,livingbodyType:a,isJustOcr:n,isJustSms:s,failInfo:i.Fail.CustomFailInfo};var c={isHideSmsPage:d.isHideSmsPage,isHideOcrPage:d.isHideOcrPage,isJustSms:d.isJustSms,isJustOcr:d.isJustOcr,navTitle:d.navTitle};if(d.skipConfig=c,0!==d.livingbodyType&&1!==d.livingbodyType){var f=4,u=d.page.livingbody.silentRecordTime;u&&"number"==typeof u&&u>4&&(f=u),d.page.livingbody.silentRecordTime=f}let g=d.page.ocr.allowModifyType.split("");return d.page.ocr.isIdnameAllowEdit="0"===g[0],d.page.ocr.isIdnumberAllowEdit="0"===g[1],d.page.ocr.isIdaddressAllowEdit="0"===g[2],console.log(d.page.ocr),d};module.exports={init:init};