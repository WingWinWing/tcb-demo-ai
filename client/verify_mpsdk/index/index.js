const regeneratorRuntime=require("../utils/regenerator-runtime/runtime"),util=require("../utils/util");var sysFailInfo=require("../config").sysFailInfo,BASE_URL="";const main=require("../main");var tokenExceptionArr=[14,11],ctx="";Page({data:{curPage:1,cmsConfig:{},skipConfig:{},bizData:{},token:"",preClickBtnTime:0,isNotCamera:!0,iKnowFuncs:[],index_rule:!1,show_about_dlg:!1,indexChecked:!0,indexDisableBtn:!1,show_auth_panel:!1,authInfo:"",isInfinityDisplay:!1,notice:{titie:"",content:""},sms:{isForbiddenSmsBtn:!0,hintError:"",isEnableSendSms:!1,is60sGap:!1,sendSmsTtitle:"获取验证码",gapSec:60,phoneNum:"",verifyCode:""},ocr:{isShowTakePhoto:!1,isShowResult:!1,isShowGuide:!0,isShowPhotoPreView:!1,isPhotoFromCamera:!1,isFrontIdCard:!0,hintError:"",hintErrorResult:"",isForbiddenManualBtn:!0,isForbiddenResultBtn:!1,idcard:"",idname:"",idaddress:"",tempImagePath:"",ocrTitle:"请拍摄身份证人像面",verifycamFullScreen:"verifycamFullScreen",isToolsShow:!0,isEditTheOcrIsManualInput:!1,isInfinityDisplayOcrTitle:"",isInfinityDisplayOcrBottom:"",isInfinityDisplayOcrMiddle:"",frontMediaKey:"",backendMediaKey:""},livingbody:{isShowGuide:!0,isShowCamera:!1,isShowProcess:!1,isShowDialog:!1,livingbodyNumber:"",isNotPrepareOk:!0,getCodeErrMsg:"",livingbodyTitle:"请保持正脸对准框内",isPrepare:!0,curNumberStatus:["verifyCurrentNumber","","",""],curNumber:["·","·","·","·"],isActionSeqNormal:"",livingbodyActionText:"",livingbodySilentText:"",uploadProcess:0,showTestVideo:!1,video_preview:"",video_src:"",isInfinityDisplayHTTitle:"",isInfinityDisplayHTBottom:"",isInfinityDisplayHTMiddle:"",isInfinityDisplayHTActionPre:"",isInfinityDisplayHTNumberPre:"",isInfinityDisplayHTActionHint:"",isInfinityDisplayHTNumberHint:""},failPage:{is_modal_showing:!1},successPage:{},failInfo:{}},onLoad:function(i){if(wx.verifyLog(i),this.setData({cmsConfig:wx.verify_CMSConfig,token:wx.verify_TOKEN}),wx.verifyLog("this.data.cmsConfig =",this.data.cmsConfig),wx.verifyLog(`this.data.token = ${this.data.token}`),wx.verifyLog(`wx.verifyBaseUrl = ${wx.verifyBaseUrl}`),BASE_URL=wx.verifyBaseUrl,wx.setNavigationBarTitle({title:this.data.cmsConfig.justForJumpVer.title,success:function(){wx.verifyLog("setNavigationBarTitle success!")},fail:function(i){wx.verifyLog("setNavigationBarTitle failure!"),wx.verifyLog(i)}}),"true"===i.isNotice)return wx.verifyLog("is notice"),this.setData({curPage:7}),void this.getTheNotice();wx.verifyLog("is not notice"),this.data.cmsConfig.isGetUserLocation&&this.getUserLocation(),this.data.cmsConfig.isHideOcrPage&&this.setData({"ocr.idcard":this.data.bizData.id_number,"ocr.idname":this.data.bizData.id_name}),wx.getSystemInfo({success:i=>{wx.verifyLog(i);var e=i.screenHeight/i.screenWidth>=2;i.screenHeight>700&&e&&this.setData({isInfinityDisplay:!0,"ocr.isInfinityDisplayOcrBottom":"isInfinityDisplayOcrBottom","ocr.isInfinityDisplayOcrMiddle":"isInfinityDisplayOcrMiddle","ocr.isInfinityDisplayOcrTitle":"isInfinityDisplayOcrTitle","livingbody.isInfinityDisplayHTBottom":"isInfinityDisplayHTBottom","livingbody.isInfinityDisplayHTMiddle":"isInfinityDisplayHTMiddle","livingbody.isInfinityDisplayHTTitle":"isInfinityDisplayHTTitle","livingbody.isInfinityDisplayHTActionPre":"isInfinityDisplayHTActionPre","livingbody.isInfinityDisplayHTNumberPre":"isInfinityDisplayHTNumberPre","livingbody.isInfinityDisplayHTActionHint":"isInfinityDisplayHTActionHint","livingbody.isInfinityDisplayHTNumberHint":"isInfinityDisplayHTNumberHint"})}})},getTheNotice(){var i={url:BASE_URL+"notices.php",data:{appid:this.data.bizData.appid}};util.request(i,i=>{if(wx.verifyLog(i),0===i.ErrorCode){var e=JSON.parse(i.Data);this.setData({"notice.content":e[0].content,"notice.title":e[0].title})}else wx.showModal({title:"提示",content:"获取公告信息失败，"+i.ErrorMsg,confirmText:"重试",showCancel:!1,confirmColor:"#2d72f1",success:i=>{i.confirm&&this.getTheNotice()}})})},onReady:function(){},onShow:function(){this.data.show_auth_panel&&setTimeout(()=>{this.isAuthOk()},500)},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){},showErrorToast:function(i){if(wx.verifyLog("showErrorToast",i),3===this.data.curPage){if(this.data.ocr.isShowResult)return void this.setData({"ocr.hintErrorResult":i.error_msg});this.data.ocr.isShowTakePhoto&&101!==i.ErrorCode&&-107!==i.ErrorCode&&this.data.iKnowFuncs.push(()=>{this.reTakePhoto()})}this.setData({showErrorMsg:!0,err:i})},switchDialog:function(){if(this.setData({showErrorMsg:!this.data.showErrorMsg}),1===this.data.iKnowFuncs.length){this.data.iKnowFuncs.pop()()}},checkNetWork:function(i){var e=this;wx.getNetworkType({success:function(t){"none"!==t.networkType?i():(wx.verifyLog("Network is none"),e.showErrorToast({ErrorCode:101,ErrorMsg:"网络异常，请稍后重试"}))},fail:function(i){wx.verifyLog("Get Network exception"),e.showErrorToast({ErrorCode:101,ErrorMsg:"网络异常，请稍后重试"})}})},checkRecordNetworkOk:function(i,e){wx.getNetworkType({success:function(t){"none"!==t.networkType?(wx.verifyLog("network is OK"),i(t.networkType)):(wx.verifyLog("Network is none"),e({ErrorCode:101,ErrorMsg:"网络异常，请稍后再试"}))},fail:function(i){wx.verifyLog("Get Network exception"),e({ErrorCode:101,ErrorMsg:"网络异常，请稍后再试"})}})},returnAllCheckNetWork(i){wx.getNetworkType({success:function(e){i(e.networkType)},fail:function(e){i("none")}})},isNotAllowClick:function(){var i=+new Date;return i-this.data.preClickBtnTime<1e3?(wx.verifyLog("Click button gap < 1s, not allow exec"),!0):(this.data.preClickBtnTime=i,wx.verifyLog("Click button gap > 1s, allow exec"),!1)},exitVerify(i){i.Token=this.data.token,i.ErrorCode=0,wx.navigateBack({success:function(e){wx.verifySuccessFunc(i)}})},exitVerifyFail(i){wx.navigateBack({success:()=>{-999!==i.ErrorCode&&wx.verifyFailureFunc(i)}})},switchIndexRule:function(){this.setData({index_rule:!this.data.index_rule})},switchAboutDlg:function(){this.setData({show_about_dlg:!this.data.show_about_dlg})},checkboxChange(i){this.setData({indexDisableBtn:!this.data.indexDisableBtn})},getUserLocation:function(){var i=this;wx.getLocation({type:"wgs84",success:function(e){wx.verifyLog("Get the location success!",e);var t={url:BASE_URL+`/api/auth/saveLocation?BizToken=${i.data.token}`,data:{Longitude:e.longitude,Latitude:e.latitude}};util.request(t,function(e){if(0===e.ErrorCode)wx.verifyLog("Report location success!");else{if(console.log(e.ErrorCode),tokenExceptionArr.includes(e.ErrorCode))return void i.exitVerifyFail(e);i.showErrorToast(e)}})},fail:function(i){wx.verifyLog("Get location failure!"),wx.verifyLog(i)}})},indexToNext:async function(){if(!this.isNotAllowClick()){var i=this;this.checkNetWork(function(){var e=i.data.cmsConfig;wx.verifyLog(e);var t=2;e.isHideSmsPage&&(t=e.isHideOcrPage?4:3),i.setData({curPage:t}),(4===t||3===t&&!i.data.cmsConfig.page.ocr.isManualInput)&&i.preLivingbodyExec()})}},phoneNumChanged(i){this.setData({"sms.hintError":""});var e=i.detail.value;this.data.sms.phoneNum=e;var t=util.validate(e,"sms_phone");wx.verifyLog(`isPhoneOk: ${t}`),t&&!this.data.sms.is60sGap&&this.setData({"sms.isEnableSendSms":!0}),t||this.setData({"sms.isEnableSendSms":!1});var o=util.validate(this.data.sms.verifyCode,"sms_verifyCode");t&&o?this.setData({"sms.isForbiddenSmsBtn":!1}):this.setData({"sms.isForbiddenSmsBtn":!0}),wx.verifyLog(`isEnableSendSms: ${this.data.sms.isEnableSendSms}`)},sendVerifyCodeReq:function(){if(!this.isNotAllowClick()){var i=this;this.checkNetWork(function(){let e={url:`${BASE_URL}/api/sms/sendsmsverifycode?BizToken=${i.data.token}`,data:{mobile_phone:i.data.sms.phoneNum}};wx.showLoading({title:"短信发送中...",mask:!0}),util.request(e,function(e){if(wx.hideLoading(),0===e.ErrorCode){i.setData({"sms.is60sGap":!0,"sms.isEnableSendSms":!1,"sms.sendSmsTtitle":"重新发送"});var t=setInterval(function(){i.data.sms.gapSec<=1&&(clearInterval(t),i.setData({"sms.is60sGap":!1,"sms.gapSec":60}),util.validate(i.data.sms.phoneNum,"sms_phone")&&i.setData({"sms.isEnableSendSms":!0})),i.setData({"sms.gapSec":i.data.sms.gapSec-1})},1e3)}else{if(tokenExceptionArr.includes(e.ErrorCode))return void i.exitVerifyFail(e);i.setData({"sms.hintError":e.ErrorMsg})}})})}},verifyCodeChanged(i){this.setData({"sms.hintError":""}),this.data.sms.verifyCode=i.detail.value;var e=util.validate(this.data.sms.verifyCode,"sms_verifyCode");util.validate(this.data.sms.phoneNum,"sms_phone")&&e?this.setData({"sms.isForbiddenSmsBtn":!1}):this.setData({"sms.isForbiddenSmsBtn":!0})},smsToNext(){if(!this.isNotAllowClick()){var i=this;this.checkNetWork(function(){wx.verifyLog(i.data.sms.phoneNum+" | "+i.data.sms.verifyCode);let e={url:`${BASE_URL}/api/sms/confirmsmsverifycode?BizToken=${i.data.token}`,data:{mobile_phone:i.data.sms.phoneNum,verify_code:i.data.sms.verifyCode}};wx.showLoading({title:"加载中...",mask:!0}),util.request(e,function(e){if(wx.hideLoading(),0===e.ErrorCode){var t=i.data.cmsConfig;if(t.isJustSms)i.exitVerify({});else{var o=3;t.isHideOcrPage&&(o=4),i.setData({curPage:o}),(4===o||3===o&&!i.data.cmsConfig.page.ocr.isManualInput)&&i.preLivingbodyExec()}}else{if(tokenExceptionArr.includes(e.ErrorCode))return void i.exitVerifyFail(e);i.setData({"sms.hintError":e.ErrorMsg})}})})}},idcartManualInputChanged(i){var e=i.detail.value;this.data.ocr.idcard=e,this.manualInputChanged()},idnameManualInputChanged(i){var e=i.detail.value;this.data.ocr.idname=e,this.manualInputChanged()},manualInputChanged(i){this.setData({"ocr.hintError":""});var e=util.validate(this.data.ocr.idcard,"idcard"),t=util.validate(this.data.ocr.idname,"idname"),o=!0;e&&t&&(o=!1),this.setData({"ocr.isForbiddenManualBtn":o})},manualInputGoNext(){this.ocrCommonInputGoNext(!0)},ocrCommonInputGoNext(i){var e=this;this.checkNetWork(function(){e.data.cmsConfig;wx.showLoading({title:"校验身份信息中...",mask:!0});var t={url:`${BASE_URL}/api/ocr/updateidinfo?BizToken=${e.data.token}`,data:{Name:e.data.ocr.idname,IdCard:e.data.ocr.idcard}};e.data.ocr.idaddress&&(t.data.Address=e.data.ocr.idaddress),util.request(t,function(t){if(wx.hideLoading(),0!==t.ErrorCode){if(tokenExceptionArr.includes(t.ErrorCode))return void e.exitVerifyFail(t);let o={"ocr.hintError":t.ErrorMsg};return i||(o={"ocr.hintErrorResult":t.ErrorMsg}),void e.setData(o)}e.ocrGoNext(i)})})},ocrGoNext(i){var e=this;if(e.data.cmsConfig.page.ocr.isCheckIDInfo){let t={url:`${BASE_URL}/api/ocr/checkidinfo?BizToken=${this.data.token}`,data:{Name:this.data.ocr.idname,IdCard:this.data.ocr.idcard}};util.request(t,t=>{if(0!==t.ErrorCode){if(tokenExceptionArr.includes(t.ErrorCode))return void e.exitVerifyFail(t);let o={"ocr.hintError":t.ErrorMsg};return i||(o={"ocr.hintErrorResult":t.ErrorMsg}),void e.setData(o)}this.ocrGoNextEnd()})}else this.ocrGoNextEnd()},ocrGoNextEnd(){this.data.cmsConfig.isJustOcr?this.exitVerify({id_name:this.data.ocr.idname,id_number:this.data.ocr.idcard,id_address:this.data.ocr.idaddress}):(this.setData({curPage:4}),this.preLivingbodyExec())},manualInputTakePhone(){this.setData({"cmsConfig.page.ocr.isManualInput":!1,"ocr.isEditTheOcrIsManualInput":!0})},ocrStartTakePhoto(){var i=this;this.checkNetWork(function(){i.setData({"ocr.isShowTakePhoto":!0,isNotCamera:!1})})},takePhotoWithCamera(){var i=this;wx.createCameraContext().takePhoto({quality:"noraml",success:e=>{wx.verifyLog(e.tempImagePath),this.setData({"ocr.tempImagePath":e.tempImagePath,"ocr.isShowPhotoPreView":!0,"ocr.ocrTitle":"照片预览","ocr.isPhotoFromCamera":!0}),wx.verifyLog(i.data.ocr.tempImagePath)},fail:i=>{wx.showToast({title:"takePhoto function exception",icon:"none"})}})},chooseImg(){var i=this;wx.chooseImage({count:1,sizeType:["compressed"],sourceType:["album"],success:function(e){var t=e.tempFilePaths;i.setData({"ocr.tempImagePath":t[0],"ocr.isShowPhotoPreView":!0,"ocr.ocrTitle":"照片预览","ocr.isPhotoFromCamera":!1}),i.setData({"ocr.isToolsShow":!1}),i.setData({"ocr.isToolsShow":!0})}})},reTakePhoto(){let i=this.data.ocr.isFrontIdCard?"请拍摄身份证人像面":"请拍摄身份证国徽面";this.setData({"ocr.tempImagePath":"","ocr.isShowPhotoPreView":!1,"ocr.ocrTitle":i})},startUploadAndOcr(){var i=this;this.checkNetWork(()=>{wx.showLoading({title:"系统识别中",mask:!0});let e={file:i.data.ocr.tempImagePath};wx.verifyLog("upfile data",e),wx.uploadFile({url:`${BASE_URL}/api/common/upLoadWxAppFile?BizToken=${i.data.token}`,filePath:this.data.ocr.tempImagePath,name:"file",formData:e,success:e=>{if(wx.verifyLog("uploadFile | ",e),200===e.statusCode){let t=JSON.parse(e.data);if(0===t.ErrorCode){let e={url:`${BASE_URL}/api/ocr/ocrinfo?BizToken=${this.data.token}`,data:{MediaKey:t.Data.MediaKey,PicType:this.data.ocr.isFrontIdCard?0:1}};wx.verifyLog("ocrinfo data",e),util.request(e,e=>{if(wx.hideLoading(),0===e.ErrorCode){if(this.data.ocr.isFrontIdCard&&this.setData({"ocr.idcard":e.Data.id,"ocr.idname":e.Data.name,"ocr.idaddress":e.Data.address}),this.data.ocr.isFrontIdCard&&this.data.cmsConfig.page.ocr.backend)return void this.setData({"ocr.tempImagePath":"","ocr.isShowPhotoPreView":!1,"ocr.ocrTitle":"请拍摄身份证国徽面","ocr.isFrontIdCard":!1});this.setData({"ocr.isShowResult":!0,isNotCamera:!0,"ocr.verifycamFullScreen":"verifycamFullScreen"})}else{if(tokenExceptionArr.includes(e.ErrorCode))return void i.exitVerifyFail(e);this.showErrorToast(e)}})}else wx.hideLoading(),this.showErrorToast({ErrorCode:101,ErrorMsg:t.ErrorMsg})}else wx.hideLoading(),this.showErrorToast({ErrorCode:101,ErrorMsg:"上传图片失败"})},fail:i=>{wx.verifyLog("upload img fail",i),wx.hideLoading(),this.showErrorToast({ErrorCode:101,ErrorMsg:"上传图片失败"})}})})},idnameInputChanged(i){this.data.ocr.idname=i.detail.value,this.ocrCommonInputCheck()},idcartInputChanged(i){this.data.ocr.idcard=i.detail.value,this.ocrCommonInputCheck()},idaddressInputChanged(i){this.data.ocr.idaddress=i.detail.value,this.ocrCommonInputCheck()},ocrCommonInputCheck(){this.setData({"ocr.hintErrorResult":""});var i=util.validate(this.data.ocr.idcard,"idcard"),e=util.validate(this.data.ocr.idname,"idname"),t=util.validate(this.data.ocr.idaddress,"idaddress"),o=!0;i&&e&&(o=!1),this.data.cmsConfig.page.ocr.isAddress&&!t&&(o=!0),this.setData({"ocr.isForbiddenResultBtn":o})},ocrInputGoNext(i){if(util.validate(this.data.ocr.idcard,"idcard"))if(util.validate(this.data.ocr.idname,"idname")){if(this.data.cmsConfig.page.ocr.isAddress)if(!util.validate(this.data.ocr.idaddress,"idaddress"))return void this.setData({"ocr.hintErrorResult":"住址格式错误"});wx.verifyLog("go next"),this.ocrCommonInputGoNext(!1)}else this.setData({"ocr.hintErrorResult":"姓名格式错误"});else this.setData({"ocr.hintErrorResult":"身份证号格式错误"})},switchLivingbodyDialog(i){this.setData({"livingbody.isShowDialog":!this.data.livingbody.isShowDialog})},preLivingbodyExec(){var i=this;if(4===this.data.curPage&&(0===this.data.cmsConfig.livingbodyType||1===this.data.cmsConfig.livingbodyType)){let e={url:`${BASE_URL}/api/liveness/lipcode?BizToken=${i.data.token}`,data:{}};1===i.data.cmsConfig.livingbodyType&&(e.url=`${BASE_URL}/api/liveness/actioncode?BizToken=${i.data.token}`),util.request(e,e=>{if(0===e.ErrorCode){wx.verifyLog("Got the LipCode："+e.Data.LipCode),wx.verifyLog("Got the ActionCode:"+e.Data.ActionCode);var t={"livingbody.livingbodyNumber":e.Data.LipCode};1===i.data.cmsConfig.livingbodyType&&(t={"livingbody.isActionSeqNormal":"21"===e.Data.ActionCode.join("")}),this.setData(t)}else{if(tokenExceptionArr.includes(e.ErrorCode))return void i.exitVerifyFail(e);this.setData({"livingbody.getCodeErrMsg":e.ErrorMsg})}})}wx.authorize({scope:"scope.camera",success(){},fail:function(){wx.verifyLog("您未允许使用摄像头权限")},complete:function(){4===i.data.curPage?wx.authorize({scope:"scope.record",success(){},fail:function(){wx.verifyLog("您未允许使用录音权限")},complete:function(){wx.verifyLog("开始判断是否有权限"),i.isAuthOk()}}):i.isAuthOk()}})},isAuthOk:function(){var i=this;wx.getSetting({success(e){wx.verifyLog("获取授权信息成功");var t=e.authSetting["scope.record"],o=e.authSetting["scope.camera"];if(4===i.data.curPage)if(t&&o)i.setData({show_auth_panel:!1,authInfo:"摄像头、录音功能都已授权"}),i.authOkToDo(),wx.verifyLog("摄像头、录音功能都已授权");else{var a="";o||(a="摄像头 "),t||(a+="录音功能"),a+="还未授权",wx.verifyLog(a),i.setData({show_auth_panel:!0,authInfo:a})}else o?i.setData({show_auth_panel:!1,authInfo:"摄像头已授权"}):i.setData({show_auth_panel:!0,authInfo:"摄像头未授权"})},fail:function(i){wx.verifyLog("获取收取信息失败",i)}})},authOkToDo(){wx.verifyLog(this.data.livingbody.livingbodyNumber,this.data.cmsConfig.livingbodyType),0===this.data.cmsConfig.livingbodyType&&""===this.data.livingbody.livingbodyNumber||1===this.data.cmsConfig.livingbodyType&&""===this.data.livingbody.isActionSeqNormal?this.theLivingBodyNumberMustBeOk():(this.livingbodyAutoShowDialog(),this.setData({"livingbody.isNotPrepareOk":!1}))},theLivingBodyNumberMustBeOk(){var i=this;wx.showModal({title:"提示",content:"获取code失败，"+i.data.livingbody.getCodeErrMsg,showCancel:!1,confirmText:"重新获取",confirmColor:"#2d72f1",success:function(e){if(e.confirm){wx.verifyLog("开始重新获取"),wx.showLoading({title:"重新获取中...",mask:!0});let e={url:`${BASE_URL}/api/liveness/lipcode?BizToken=${i.data.token}`,data:{}};1===i.data.cmsConfig.livingbodyType&&(e.url=`${BASE_URL}/api/liveness/actioncode?BizToken=${i.data.token}`),util.request(e,e=>{if(wx.hideLoading(),0===e.ErrorCode)wx.verifyLog("Got the LipCode："+e.Data.LipCode),wx.verifyLog("Got the ActionCode:"+e.Data.ActionCode),i.livingbodyAutoShowDialog(),1===i.data.cmsConfig.livingbodyType?i.setData({"livingbody.isActionSeqNormal":"21"===e.Data.ActionCode.join(""),"livingbody.isNotPrepareOk":!1}):i.setData({"livingbody.livingbodyNumber":e.Data.LipCode,"livingbody.isNotPrepareOk":!1});else{if(tokenExceptionArr.includes(e.ErrorCode))return void i.exitVerifyFail(e);i.setData({"livingbody.getCodeErrMsg":e.ErrorMsg}),i.theLivingBodyNumberMustBeOk()}})}}})},livingbodyAutoShowDialog(){let i=wx.getStorageSync("isAlreadyShowVideoRule");wx.verifyLog("isAlreadyShowVideoRule:"+i),i||(this.setData({"livingbody.isShowDialog":!this.data.livingbody.isShowDialog}),wx.setStorage({key:"isAlreadyShowVideoRule",data:"true"}))},livingbodyStartToRecord(){this.checkNetWork(()=>{wx.verifyLog("go"),this.setData({"livingbody.isShowCamera":!0,isNotCamera:!1}),setTimeout(()=>{this.checkRecordNetworkOk(()=>{ctx=wx.createCameraContext(),wx.verifyLog("start startRecord",+new Date),ctx.startRecord({success:i=>{wx.verifyLog("startRecord success",+new Date);let e=this.data.cmsConfig.livingbodyType,t={"livingbody.isPrepare":!1},o=0,a=1200,r=1e3,s=this.data.livingbody.livingbodyNumber+"",n=["","","",""],d=["·","·","·","·"],c=this.data.cmsConfig.page.livingbody.silentRecordTime-1;if(0===e)d[o]=s[o],n[o]="verifyCurrentNumber",t["livingbody.livingbodyTitle"]="请大声朗读以下数字",t["livingbody.curNumberStatus"]=n,t["livingbody.curNumber"]=d,r=1500;else if(1===e){let i=this.data.livingbody.isActionSeqNormal;t["livingbody.livingbodyTitle"]="请做以下动作",t["livingbody.livingbodyActionText"]=i?"眨眨眼":"张张嘴",a=2e3}else t["livingbody.livingbodySilentText"]=c,a=1e3;this.setData(t);let l=setInterval(()=>{if(0===e){if(3===o)return clearInterval(l),void this.stopRecordAndProcess(r);d[++o]=s[o],n[o]="verifyCurrentNumber",this.setData({"livingbody.curNumberStatus":n,"livingbody.curNumber":d})}else if(1===e){if(1===o)return clearInterval(l),void this.stopRecordAndProcess(r);o++,this.setData({"livingbody.livingbodyActionText":this.data.livingbody.isActionSeqNormal?"张张嘴":"眨眨眼"})}else{if(0===c)return clearInterval(l),void this.stopRecordAndProcess(r);c--,this.setData({"livingbody.livingbodySilentText":c})}},a)},fail:i=>{this.setData({"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,isNotCamera:!0,"livingbody.isPrepare":!0}),wx.verifyLog("start record fail",+new Date,i),this.showErrorToast({ErrorCode:-108,ErrorMsg:`网络异常，${i.errMsg}`})},timeoutCallback:i=>{wx.verifyLog("timeoutCallback",i),this.setData({"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,isNotCamera:!0,"livingbody.isPrepare":!0}),this.showErrorToast({ErrorCode:-108,ErrorMsg:"startRecord timeoutCallback, 请重试！"})}})},i=>{this.setData({"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,isNotCamera:!0}),this.showErrorToast(i)})},2e3)})},stopRecordAndProcess(i){wx.verifyLog("start stopRecord",+new Date),setTimeout(()=>{wx.verifyLog("stopTimeGap"+i),wx.verifyLog(ctx.stopRecord),ctx.stopRecord({success:i=>{wx.verifyLog("stopRecord success",+new Date,i),wx.getFileInfo({filePath:i.tempVideoPath,success:e=>{var t=Math.round(e.size/1e3);t>8192?(this.setData({"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,isNotCamera:!0,"livingbody.isPrepare":!0}),this.showErrorToast({ErrorCode:-108,ErrorMsg:"视频大小超过限制"})):this.processTheVideo(i.tempVideoPath,t+"K")},fail:i=>{this.setData({"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,isNotCamera:!0,"livingbody.isPrepare":!0}),this.showErrorToast({ErrorCode:-108,ErrorMsg:`getFileInfo异常，${i.errMsg}`})}})},fail:i=>{this.setData({"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,isNotCamera:!0,"livingbody.isPrepare":!0}),this.showErrorToast({ErrorCode:-108,ErrorMsg:`stopRecord异常，${i.errMsg}`})},complete(i){wx.verifyLog("complete",i)}})},i)},processTheVideo(i,e){this.checkRecordNetworkOk(t=>{this.goToProcessPage(i,e)},t=>{this.setData({"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,isNotCamera:!0,"livingbody.isPrepare":!0}),wx.showModal({title:"提示",content:"网络异常，请检查网络后重试",confirmText:"重试",confirmColor:"#2d72f1",success:t=>{t.confirm&&this.processTheVideo(i,e)}})})},goToProcessPage(i,e){this.setData({"livingbody.isShowGuide":!1,"livingbody.isShowCamera":!1,"livingbody.isShowProcess":!0,isNotCamera:!0,"livingbody.isPrepare":!0});let t={url:`${BASE_URL}/api/common/upLoadWxAppFile?BizToken=${this.data.token}`,filePath:i,data:{file:i}};this.uploadTheVideo(t,e)},uploadTheVideo(i,e){this.returnAllCheckNetWork(t=>{"wifi"!==t&&"none"!==t?wx.showModal({title:"提示",content:`视频大约${e}，在移动网络环境下上传会产生手机流量，确认继续？`,confirmText:"继续",confirmColor:"#2d72f1",success:t=>{t.confirm?this.uploadTheVideoMain(i,e):this.setData({"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,"livingbody.isShowProcess":!1,isNotCamera:!0,"livingbody.isPrepare":!0})}}):this.uploadTheVideoMain(i,e)})},uploadTheVideoMain(i,e){util.uploadFile.call(this,i,t=>{if(console.log("上传视频成功"),console.log(t),0===t.ErrorCode)wx.verifyLog("uploadSuccess"),console.log(t.Data.Data.MediaKey),this.livingbodyVerify(t.Data.Data.MediaKey);else{var o="网络异常，上传视频失败";101!==t.ErrorCode&&(o=t.ErrorMsg),wx.showModal({title:"提示",content:o,showCancel:!1,confirmText:"重试",confirmColor:"#2d72f1",success:t=>{t.confirm&&this.uploadTheVideo(i,e)}})}})},livingbodyVerify(i){let e=this.data.cmsConfig.livingbodyType,t="/api/liveness/lipliveness";1===e?t="/api/liveness/actionliveness":2===e&&(t="/api/liveness/silentliveness");let o={url:`${BASE_URL}${t}?BizToken=${this.data.token}`,data:{MediaKey:i}};wx.verifyLog(o),util.request(o,e=>{if(wx.verifyLog(e),0===e.ErrorCode)this.data.cmsConfig.page.success.isAutoSkip?this.exitVerify({}):this.setData({curPage:6});else if(-107===e.ErrorCode||101===e.ErrorCode)wx.showModal({title:"提示",content:e.error_msg,showCancel:!1,confirmText:"重试",confirmColor:"#2d72f1",success:e=>{e.confirm&&this.livingbodyVerify(i)}});else{void 0===e.ErrorCode&&(e.ErrorCode="9999",sysFailInfo[9999].tips1=e.Data);var t=e.ErrorCode+"",o={};o=this.data.cmsConfig.failInfo&&this.data.cmsConfig.failInfo[t]?this.data.cmsConfig.failInfo[t]:sysFailInfo[t]?sysFailInfo[t]:{img:"",msg:e.ErrorMsg,error_code:e.ErrorCode},this.setData({failInfo:o,curPage:5})}})},failReVerify(){if(wx.verifyLog(this.data.failInfo),"无效请求"!==this.data.failInfo.msg&&14!==this.data.failInfo.error_code){var i=4;if("703"===this.data.failInfo.error_code){if(this.data.cmsConfig.isHideOcrPage)return void this.exitVerifyFail({Token:this.data.token,ErrorCode:703,ErrorMsg:"姓名身份证号不一致，请检查身份信息是否正确！"});i=3,this.setData({"ocr.isShowTakePhoto":!1,"ocr.isShowResult":!1,"ocr.isShowGuide":!0,"ocr.isShowPhotoPreView":!1,"ocr.isPhotoFromCamera":!1,"ocr.isFrontIdCard":!0,"ocr.hintError":"","ocr.hintErrorResult":"","ocr.isForbiddenManualBtn":!0,"ocr.isForbiddenResultBtn":!1,"ocr.idcard":"","ocr.idname":"","ocr.idaddress":"","ocr.tempImagePath":"","ocr.ocrTitle":"请拍摄身份证人像面","ocr.isToolsShow":!0}),this.data.ocr.isEditTheOcrIsManualInput&&this.setData({"cmsConfig.page.ocr.isManualInput":!0})}this.setData({curPage:i,"livingbody.isShowGuide":!0,"livingbody.isShowCamera":!1,"livingbody.isShowProcess":!1,"livingbody.isShowDialog":!1,"livingbody.livingbodyNumber":"","livingbody.isNotPrepareOk":!0,"livingbody.getCodeErrMsg":"","livingbody.livingbodyTitle":"请保持正脸对准框内","livingbody.isPrepare":!0,"livingbody.curNumberStatus":["verifyCurrentNumber","","",""],"livingbody.curNumber":["·","·","·","·"],"livingbody.isActionSeqNormal":!0,"livingbody.livingbodyActionText":"","livingbody.livingbodySilentText":"","livingbody.uploadProcess":0}),this.preLivingbodyExec()}else{this.exitVerifyFail({ErrorCode:14,ErrorMsg:"由于活体验证时出现网络异常，导致无效请求，需要您重新验证，验证时请保持网络畅通！"})}},successGoToNext(){this.exitVerify({})},verifyBackToIndex(){var i={};i.Token=this.data.token,i.ErrorCode=-999,i.ErrorMsg="返回首页成功，如多次验证不通过，可将当前页面截图提供给相关工作人员排查问题 "+this.data.bizData.appid+" | "+i.token,this.exitVerifyFail(i)},switchfailModal(){this.setData({"failInfo.is_modal_showing":!this.data.failInfo.is_modal_showing})},ocrCameraError:function(i){wx.verifyLog("ocrCameraError",i)},bindstop:function(i){wx.verifyLog(i)}});